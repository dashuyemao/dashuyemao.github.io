var system = require('system'),
    webpage = require('webpage');

var SCREEN_FOLD_Y = 1024,
    SCREEN_FOLD_X = 768;

if (system.args.length === 1) {
    console.log('Usage: ' + system.args[0] + ' <some URL>');
    phantom.exit();
}

var addBelowFoldClass = function () {
  var SCREEN_FOLD_Y = 1024,
      rows = document.getElementsByClassName('book-row'),
      row = null,
      topOffset = null;
  for (var i = 0; i < rows.length; i++) {
    row = rows[i];
    topOffset = row.getBoundingClientRect().top + window.pageYOffset;
    if (topOffset > SCREEN_FOLD_Y) {
      row.classList.add("book-row-below-fold");
      row.classList.add("book-row-below-fold-hidden");
    }
  }
};

var page = webpage.create(),
    url = system.args[1];

page.viewportSize = { width: SCREEN_FOLD_X, height: SCREEN_FOLD_Y };

page.open(url, function (status) {
  if (status !== 'success') {
    console.warn('Could not load page ' + url);
    phantom.exit(1);
  }

  page.evaluate(addBelowFoldClass);
  console.log(page.frameContent);
  phantom.exit(0);
});