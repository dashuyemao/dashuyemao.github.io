define([
  'underscore'
  ],
  function(_) {

    var RememberLastPage = function(bookstrap) {
      _.bindAll(this);

      bookstrap.on('navloaded', this.setStartPageIndexOnNavLoad);
      bookstrap.on('pageload', this.rememberPage);

      this.bookstrapConfig = bookstrap.config;
    };

    RememberLastPage.prototype = {

      rememberPage: function(domPage) {
        window.localStorage.setItem('Bookstrap.RememberLastPage.lastPageHref', domPage.page.href);
      },

      getLastPageHref: function() {
        return window.localStorage.getItem('Bookstrap.RememberLastPage.lastPageHref');
      },

      setStartPageIndexOnNavLoad: function(pageColllection) {
        var page = pageColllection.findByURL(this.getLastPageHref());
        if (page)
          this.bookstrapConfig.startPageIndex = pageColllection.indexOf(page);
      }

    };

    return RememberLastPage;
});