/*global bookstrap: false */
define([
  'underscore'
  ],
  function(_) {

    var ImagesLoaded = function() {
      _.bindAll(this);

      this.numImages = 0;
      this.numLoaded = 0;
      this.page = null;

      bookstrap.on('pageload', this.onPageLoad);
    };

    ImagesLoaded.prototype.onPageLoad = function(page) {
      var $images = $('img', page.$el);
      this.numLoaded = 0;
      this.numImages = $images.length;
      this.page = page;

      if (this.numImages === 0)
        this.fireImagesLoadedEvent();
      else
        this.waitForImagesToLoad($images);
    };

    ImagesLoaded.prototype.waitForImagesToLoad = function($images) {
      var self = this;
      $images.each(function() {
        // When Bookstrap is running on content that is already loaded in the DOM often images are
        // loaded before this JS is run
        if (this.complete) {
          self.onImgLoad();
        } else {
          $(this).one('load', self.onImgLoad);
          $(this).one('error', self.onImgLoad);
        }
      });
    };

    ImagesLoaded.prototype.fireImagesLoadedEvent = function() {
      bookstrap.emit('pageimagesload', this.page);
    };

    ImagesLoaded.prototype.onImgLoad = function() {
      this.numLoaded++;
      if (this.numLoaded === this.numImages) {
        this.fireImagesLoadedEvent();
      }
    };

    return ImagesLoaded;
});