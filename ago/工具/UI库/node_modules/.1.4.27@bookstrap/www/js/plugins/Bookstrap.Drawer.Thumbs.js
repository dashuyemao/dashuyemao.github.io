/*global bookstrap: false */
define([
  'underscore'],
  function(_) {
    var THUMBNAIL_WIDTH = (122 + 5),
        THUMBNAIL_HEIGHT = 160;

    var DrawerThumbsPlugin = function(drawer) {
      //this.nav = drawer.find('section nav');
      this.nav = $('.book-drawer-content section nav');
      this.links = null;
      this.lastScrollLeft = 0;
      
      _.bindAll(this);
      bookstrap.on('navigationcached', this.onNavigationCached);
      bookstrap.on('pageload', this.onPageLoad);
      this.nav.on('scroll', this.onScroll);

      this.nav.on('dragstart', 'img', function(){
        return false;
      });
    };

    DrawerThumbsPlugin.prototype = {
      onNavigationCached: function(){
        this.links = this.nav.find('li');

        this.nav.find('ol').width( this.links.size() * (THUMBNAIL_WIDTH));

        this.loadByScroll(this.lastScrollLeft);
        this.scrollToThumbnail(bookstrap.domPages.current.page);
      },
      onPageLoad: function(domPage) {
        this.scrollToThumbnail(domPage.page);
      },
      onScroll: function(e) {
        this.loadByScroll(e.target.scrollLeft);
      },
      loadByScroll: function(scrollPos) {
        var self = this,
            firstVisibleIndex = Math.ceil(scrollPos / THUMBNAIL_WIDTH);

        var toCache = this.links.slice(Math.max(0, firstVisibleIndex - 30), Math.max(0, firstVisibleIndex + 60));
        toCache.each(function(i, el){
          self.insertThumbnail($(el).find('a'));
        })
      },
      insertThumbnail: function($link) {
        var title = $link.text();
        if (!title.length)
          return;

        var page = bookstrap.pages.findByURL($link.attr('href'));
        $link.data('title', title);
        var thumb = new Image();
        thumb.src = page.thumbnail;
        thumb.alt = title;
        $link.html(thumb);
        if (page.spread){
          var spreadSide = page.spreadIndex % 2 == 0 ? 'even' : 'odd';
          $link.parent().addClass('book-spread-page-' + spreadSide);
        }
      },
      scrollToThumbnail: function(page) {
        var currentIndex = bookstrap.pages.pages.indexOf(page),
            scrollTo = THUMBNAIL_WIDTH * (currentIndex + 1) - bookstrap.viewport.width/2;
        this.nav.prop('scrollLeft', scrollTo);        
      }
    };
    return DrawerThumbsPlugin;
});