define([
  'plugins/Bookstrap.Mask',
  'plugins/Bookstrap.Drawer'
],
function(Mask, Drawer) {

  var DrawerManager = function(bookstrap) {
    this.drawers = [];
    this.mask = new Mask({
      'customClass': 'book-drawer-mask'
    });

    var self = this;
    bookstrap.on('ready', function() {
      self.init(bookstrap, {
        pages: bookstrap.pages.pages,
        title: bookstrap.title
      });
    });
  };

  DrawerManager.prototype.init = function(bookstrap, opts) {
    var elms = $('.book-drawer');
    var self = this;
    $.each(elms, function(i,elm) {
      self.drawers.push(new Drawer(bookstrap, elm, self.mask));
    });

    if (self.drawers.length == 0) {
      return this;
    }

    if (opts.pages) {
      self.renderTOC(self.drawers[0].$el, opts.pages);
    }

    if (opts.title) {
      self.drawers[0].$el.find('.book-title').text(opts.title);
    }

  };

  DrawerManager.prototype.renderTOC = function($el, pages) {
    pages.forEach(function( page) {
      var link = $('<a>');
      link.attr({ href: page.href })
          .text(page.title);
      if(page.list !== "false") {
        $el.find('ol').append($('<li>').append(link));
      }
    });

  };

  return DrawerManager;
});