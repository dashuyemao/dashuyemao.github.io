define([
  'underscore'
  ],
  function(_) {

    var DeepLink = function(bookstrap) {
      _.bindAll(this);

      bookstrap.on('navloaded', this.setStartPageFromHash);
      bookstrap.on('pageload', this.setHash);
      $(window).on('hashchange', this.onHashChange);
    };

    DeepLink.prototype = {
      setHash: function(domPage) {
        var href = domPage.page.href;
        // remove basePath if present
        if (href.indexOf(bookstrap.config.basePath) === 0) {
          href = href.substr(bookstrap.config.basePath.length);
        }
        var pageHash = '#' + href;
        window.location.hash = pageHash;
      },

      setStartPageFromHash: function(pages) {
        var href = this.getHrefFromHash(),
            page = pages.findByURL(this.getHrefFromHash());
        if (page) {
          bookstrap.config.startPageIndex = pages.indexOf(page);
        }
      },

      loadPageByHash: function() {
        var href = this.getHrefFromHash();
        bookstrap.navigate(href);
      },

      onHashChange: function() {
        var currentPageHref = bookstrap.domPages.current.page.href,
            pageHref = this.getHrefFromHash();

        if (pageHref != currentPageHref) {
          this.loadPageByHash();
        }
      },

      getHrefFromHash: function() {
        var href = null;
        if (window.location.hash) {
          var href = bookstrap.config.basePath + window.location.hash.replace(/^#/, '');
        }
        return href;
      }
    };

    return DeepLink;
});