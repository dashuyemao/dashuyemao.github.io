define(['underscore', 'plugins/Bookstrap.Mask'], function(_, Mask) {
  var popoverContainerSelector = '.book-popover';

  var VISIBLE_CLASS = 'book-visible';

  function PopoverPlugin() {
    _.bindAll(this);
    this.currentPage = null;
    this.$popoverLink = null;
    this.originalDimensions = null;
    bookstrap.on('ready', this.init);
  }

  PopoverPlugin.prototype.init = function(){
    bookstrap.on('pageload', this.onPageLoad);
    bookstrap.navigation.setLinkHandler('popover', this.onClick);
    bookstrap.on('resize', this.onResize);
  };

  PopoverPlugin.prototype.onPageLoad = function(domPage) {
    this.currentPage = domPage.$el;
    this.bindEvents();
    this.createMask();
  };

  PopoverPlugin.prototype.onClickClose = function(close){
      return function(event){
        event.stopImmediatePropagation();
        var elem = $(this).closest(popoverContainerSelector);
        close(elem, false);
      };
  };

  PopoverPlugin.prototype.bindEvents = function() {
      var viewport = bookstrap.viewport && bookstrap.viewport.$el;

      if (!this.currentPage.find(popoverContainerSelector).length) {
        return;
      }

      if (!viewport.length) {
        viewport = $(document);
      }

      viewport.on('click', '.popover-close', this.onClickClose(this.close));
      viewport.on('click', popoverContainerSelector, this.onClickClose(this.close));
    };

    PopoverPlugin.prototype.onClick = function(href, rel, link) {
      var self = this,
          popover = $(self.currentPage).find(href);

      self.activateLink($(link));
      self.showPopover(popover);
    };

    PopoverPlugin.prototype.onResize = function() {
      var popover = $('.' + VISIBLE_CLASS);
      if (popover.length) {
        this.setPosition(popover);
      }
    };

    PopoverPlugin.prototype.close = function(el, silent) {
      this.hidePopover(el, silent);
      this.removeLinkActiveState();
    };

    PopoverPlugin.prototype.removeLinkActiveState = function() {
      if (this.$popoverLink)
        this.$popoverLink.removeClass('book-active');
    };

    PopoverPlugin.prototype.activateLink = function(el) {
      this.$popoverLink = el;
      this.$popoverLink.addClass('book-active');
    };

    PopoverPlugin.prototype.getScroll = function() {
      return {
        'top': this.currentPage.get(0).scrollTop,
        'left': this.currentPage.get(0).scrollLeft,
        'height': this.currentPage.get(0).scrollHeight,
        'width': this.currentPage.get(0).scrollWidth
      };
    };

    PopoverPlugin.prototype.getPage = function() {
      var $el = this.currentPage.find('article');

      return _.extend({
        '$el': $el,
        'width': $el.width(),
        'height': $el.height()
      }, $el.offset());
    };

    PopoverPlugin.prototype.getViewportDimensions = function() {
      var win;
      win = $(window);

      return {
        'width': win.width(),
        'height': win.height()
      };
    };

    PopoverPlugin.prototype.setPosition = function($el) {
      var popover,
          scroll,
          page,
          parent,
          style,
          type,
          viewport;

      scroll = this.getScroll();
      page = this.getPage();
      viewport = this.getViewportDimensions();

      popover = {
        '$el': $el,
        'width': $el.width(),
        'height': $el.height()
      };

      parent = { 'id': popover.$el.data('parent') };

      if (parent.id) {
        parent.$el = $('#' + parent.id);
      } else {
        parent.$el = this.$popoverLink;
      }

      _.extend(parent, {
        'width': parent.$el.width(),
        'height': parent.$el.height()
      });

      parent.pageOffset = parent.$el.offset();

      parent.offset = {
        'top': parent.pageOffset.top, 
        'left': parent.pageOffset.left - scroll.left,
      };

      _.extend(parent.offset, {
        'bottom': viewport.height - parent.offset.top - parent.height,
        'right': viewport.width - parent.offset.left - parent.width
      });

      type = popover.$el.data('type') || 'center';
      style = {};

      __setPosition = {
        reset: function() {
          style = {
            'left': 'auto',
            'right': 'auto',
            'top': 'auto',
            'bottom': 'auto',
            'position': 'absolute',
            'min-width': 0,
            'min-height': 0,
            'max-width': 'auto',
            'max-height': 'auto',

            'margin': 'auto'
          };
        },

        auto: function() {
          var height = popover.height + 15,
              width = popover.width + 15,
              position = 'center',
              align = 'left';

          __setPosition.reset();

           if (parent.offset.top > height) {
            position = 'top';
          } else if (parent.offset.bottom > height) {
            position = 'bottom';
          } else if (parent.offset.left > width) {
            position = 'left';
          } else if (parent.offset.right > width) {
            position = 'right';
          }

          if (position === 'top' || position === 'bottom') {
            if (parent.offset.right + parent.width < popover.width) {
              align = 'right';
            }

            if (parent.offset.left + parent.width < popover.width) {
              if (align === 'right') {
                position = 'center';
              }

              align = 'left';
            }
          } else {
            if (parent.offset.bottom + parent.height < popover.height) {
              align = 'bottom';
            }

            if (parent.offset.top + parent.height < popover.height) {
              if (align === 'bottom') {
                position = 'center';
              }

              align = 'top';
            }
          }

          if (position === 'center') {
            return __setPosition.center();
          }

          switch (position) {
            case 'top':
              style.top = parent.pageOffset.top - height;
              break;

            case 'bottom':
              style.top = parent.pageOffset.top + parent.height + 15;
              break;

            case 'left':
              style.left = parent.pageOffset.left - width - page.left;
              break;

            case 'right':
              style.left = parent.pageOffset.right + parent.width + 15;
              break;
          }

          switch (align) {
            case 'top':
              style.top = parent.pageOffset.top;
              break;

            case 'bottom':
              style.top = parent.pageOffset.top - parent.offset.bottom;
              break;

            case 'left':
              style.left = parent.pageOffset.left;
              break;

            case 'right':
              style.left = parent.pageOffset.left - parent.offset.right;
              break;
          }
          style.top -= page.top;
          style.left -= page.left;
        },

        center: function() {
          __setPosition.reset();
          _.extend(style, {
            'top': (scroll.top + (viewport.height / 2)) - (popover.height / 2),
            'left': (scroll.left + (viewport.width / 2)) - (popover.width / 2)
          });
        },

        snap: function() {
          __setPosition.reset();
          _.extend(style, {
            'top': parent.pageOffset.top - page.top,
            'left': parent.pageOffset.left,
            'min-width': parent.width,
            'min-height': parent.height
          });
        }
      };

      __setPosition[type]();
      popover.$el.css(style);
    };

    PopoverPlugin.prototype.showPopover = function(el) {
      var $el = $(el);

      $el.show();

      this.showMask();
      this.setPosition($el);

      $el.addClass(VISIBLE_CLASS);
      bookstrap.emit('popover:show', el);
    };

    PopoverPlugin.prototype.hidePopover = function(el, silent) {
      el = $(el);
      if(el.length > 0){
        var iframes = el.find('iframe');
        if (iframes.length > 0) {
          iframes.each(function(i, iframe){
            iframe.contentWindow.location.reload();
          });
        }
        el.removeClass(VISIBLE_CLASS).hide();
        bookstrap.emit('popover:hide', el);
        if (!silent) {
          this.hideMask();
        }
      }
    };

    PopoverPlugin.prototype.createMask = function() {
      var self = this;

      this.mask = new Mask({
        'parent': this.currentPage.find('article')
      });

      this.mask.on('hide', function() {
        var elem = $(popoverContainerSelector).filter('.' + VISIBLE_CLASS);
        self.close(elem, true);
      });
    };

    PopoverPlugin.prototype.showMask = function() {
      this.mask.show();
    };

    PopoverPlugin.prototype.hideMask = function() {
      this.mask.hide();
    };


  return PopoverPlugin;
});
