/*global bookstrap: false */
define([
  'underscore'
  ],
  function(_) {

    var BELOW_FOLD_CLASS = 'book-row-below-fold',
        BELOW_FOLD_HIDDEN_CLASS = 'book-row-below-fold-hidden';

    var LazyLoadBelowFold = function() {
      this.domPage = null;

      _.bindAll(this);
      bookstrap.on('pagecache', this.onPageCache);
      bookstrap.on('pageload', this.onPageLoad);
      bookstrap.on('pageunload', this.onPageUnload);
    };

    LazyLoadBelowFold.prototype.onPageCache = function(domPage) {
      domPage.isContentBelowFoldVisible = false;
    };

    LazyLoadBelowFold.prototype.onPageLoad = function(domPage) {
      this.domPage = domPage;
      this.domPage.$el.on('scroll', this.showBelowFold);
    };

    LazyLoadBelowFold.prototype.onPageUnload = function(domPage) {
      this.unbindEvents();
    };

    LazyLoadBelowFold.prototype.unbindEvents = function() {
      this.domPage.$el.off('scroll', this.showBelowFold);
    };

    LazyLoadBelowFold.prototype.showBelowFold = function(event) {
      if (this.domPage.isContentBelowFoldVisible) return;
      var userHasStartedScrolling = event.target.scrollTop > 30;
      if (! userHasStartedScrolling) {
        return;
      }
      this.domPage.$el.find('.' + BELOW_FOLD_CLASS).toggleClass(BELOW_FOLD_HIDDEN_CLASS);
      this.domPage.isContentBelowFoldVisible = true;
      this.unbindEvents();
    };

    return LazyLoadBelowFold;
});