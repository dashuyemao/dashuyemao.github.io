/* 
 * WebView plugin
 * Opens external links in an iframe
 *
 * If using Cordova/PhoneGap you may need to edit Cordova.plist:
 *
 *  - the iFrame URL is in the ExternalHosts whitelist
 *  - OpenAllWhitelistURLsInWebView is set to YES
 *
 */

define(['underscore', 'plugins/Bookstrap.Mask'], function(_, Mask) {
  var LINK_SELECTOR = '[rel=external]';

  var documentContainer = document,
      template = ['<div class="bookstrap-webview">',
                  '<iframe></iframe>',
                  '<button class="bookstrap-webview-close"></button>',
                  '</div>'].join('');

  var WebViewPlugin = function(bookstrap) {
    bookstrap.on('ready', _.bind(this.init, this));
  };

  WebViewPlugin.prototype = {
    init: function() {
      this.mask = new Mask();

      this.mask.on('hide', $.proxy(this.close, this));

      $(documentContainer).on('click touchend', LINK_SELECTOR, $.proxy(this.open, this));
    },

    open: function(event) {
      event.preventDefault();
      this.frame().find('iframe').attr('src', event.target.href);
      this.mask.show();
      this.frame().show();
    },

    close: function(event) {
      this.frame().hide();
      if (event) {
        this.mask.hide();
      }
    },

    frame: function() {
      if (!this._$frame) {
        this._$frame = $(template);
        $('body').append(this._$frame);

        this._$frame.on('click touchend', 'button', $.proxy(this.close, this));
      }

      return this._$frame;
    },
  };

  return WebViewPlugin;
});
